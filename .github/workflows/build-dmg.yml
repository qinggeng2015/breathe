name: Build DMG Packages

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

# æ·»åŠ å¿…è¦çš„æƒé™é…ç½®
permissions:
  contents: write  # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»ºrelease
  packages: write  # å¯é€‰ï¼šå¦‚æžœéœ€è¦å‘å¸ƒpackage
  actions: read    # éœ€è¦è¯»å–actionsçš„æƒé™

env:
  SCHEME: breathe
  APP_NAME: breathe

jobs:
  build:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]
        include:
          - arch: x86_64
            destination: 'platform=macOS,arch=x86_64'
            runner_arch: intel
          - arch: arm64
            destination: 'platform=macOS,arch=arm64'
            runner_arch: apple_silicon

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Show Xcode version
      run: xcodebuild -version

    - name: Show available schemes
      run: xcodebuild -list -project breathe.xcodeproj

    - name: Build for ${{ matrix.arch }}
      run: |
        xcodebuild clean build \
          -project breathe.xcodeproj \
          -scheme ${{ env.SCHEME }} \
          -configuration Release \
          -destination '${{ matrix.destination }}' \
          -derivedDataPath DerivedData \
          CODE_SIGNING_ALLOWED=NO \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGN_ENTITLEMENTS="" \
          PROVISIONING_PROFILE_SPECIFIER=""

    - name: Find built app
      id: find_app
      run: |
        APP_PATH=$(find DerivedData/Build/Products/Release -name "${{ env.APP_NAME }}.app" -type d | head -1)
        echo "APP_PATH=$APP_PATH" >> $GITHUB_OUTPUT
        echo "Found app at: $APP_PATH"
        ls -la "$APP_PATH"

    - name: Verify app architecture
      run: |
        APP_PATH="${{ steps.find_app.outputs.APP_PATH }}"
        BINARY_PATH="$APP_PATH/Contents/MacOS/${{ env.APP_NAME }}"
        
        if [ -f "$BINARY_PATH" ]; then
          echo "Binary architecture info:"
          file "$BINARY_PATH"
          lipo -info "$BINARY_PATH" || echo "Single architecture binary"
        else
          echo "Warning: Binary not found at $BINARY_PATH"
          find "$APP_PATH" -type f -name "${{ env.APP_NAME }}" -exec file {} \;
        fi

    - name: Create temporary DMG directory
      run: |
        mkdir -p dmg_temp
        cp -R "${{ steps.find_app.outputs.APP_PATH }}" dmg_temp/
        # Create Applications folder symlink for easy installation
        ln -s /Applications dmg_temp/Applications

    - name: Create DMG for ${{ matrix.arch }}
      id: create_dmg
      run: |
        DMG_NAME="${{ env.APP_NAME }}-${{ matrix.arch }}.dmg"
        
        # Create DMG
        hdiutil create -srcfolder dmg_temp \
          -volname "${{ env.APP_NAME }}" \
          -fs HFS+ \
          -fsargs "-c c=64,a=16,e=16" \
          -format UDBZ \
          "$DMG_NAME"
        
        # Verify DMG was created
        if [ -f "$DMG_NAME" ]; then
          echo "DMG created successfully: $DMG_NAME"
          ls -lh "$DMG_NAME"
          echo "DMG_PATH=$DMG_NAME" >> $GITHUB_OUTPUT
        else
          echo "Error: DMG creation failed"
          exit 1
        fi

    - name: Upload DMG artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-${{ matrix.arch }}-dmg
        path: ${{ steps.create_dmg.outputs.DMG_PATH }}
        retention-days: 30

    - name: Prepare app bundle for upload
      run: |
        # Create a predictable directory structure for upload
        mkdir -p app_bundle
        cp -R "${{ steps.find_app.outputs.APP_PATH }}" app_bundle/
        echo "=== App bundle structure for upload ==="
        ls -la app_bundle/
        find app_bundle -type f | head -10

    - name: Upload app bundle artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.APP_NAME }}-${{ matrix.arch }}-app
        path: app_bundle/
        retention-days: 30



  release:
    needs: [build]
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all DMG artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: "*-dmg"
        merge-multiple: true

    - name: List downloaded files
      run: |
        echo "=== Downloaded files ==="
        ls -la *.dmg
        echo "=== File sizes ==="
        du -h *.dmg

    - name: Set build time
      id: build_time
      run: |
        BUILD_TIME=$(date '+%Y-%m-%d %H:%M:%S UTC')
        echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_OUTPUT
        echo "æž„å»ºæ—¶é—´: $BUILD_TIME"

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          *.dmg
        draft: false
        prerelease: false
        generate_release_notes: true
        name: "å‘¼å¸ç»ƒä¹ åº”ç”¨ ${{ github.ref_name }}"
        body: |
          ## ðŸŒ¸ å‘¼å¸ç»ƒä¹ åº”ç”¨ - ${{ github.ref_name }}
          
          è¿™æ˜¯ä¸€ä¸ªç®€æ´ä¼˜é›…çš„macOSçŠ¶æ€æ å‘¼å¸ç»ƒä¹ åº”ç”¨ï¼Œå¸®åŠ©æ‚¨åœ¨å·¥ä½œä¸­ä¿æŒä¸“æ³¨å’Œæ”¾æ¾ã€‚
          
          ### ðŸ“¦ ä¸‹è½½é€‰é¡¹
          - **breathe-x86_64.dmg** - Intel Macä¸“ç”¨ç‰ˆæœ¬
          - **breathe-arm64.dmg** - Apple Silicon Macä¸“ç”¨ç‰ˆæœ¬
          
          ### âœ¨ åŠŸèƒ½ç‰¹è‰²
          - ðŸŽ¯ çŠ¶æ€æ å‘¼å¸åŠ¨ç”»æŒ‡å¯¼
          - ðŸŽ¨ ç®€æ´çš„ç™½è‰²åœ†åœˆåŠ¨ç”»
          - ðŸ“ å®žæ—¶æ–‡å­—æç¤ºï¼ˆå¸æ°”ã€å±æ¯ã€å‘¼æ°”ï¼‰
          - âš¡ è½»é‡çº§ï¼Œä¸å½±å“ç³»ç»Ÿæ€§èƒ½
          - ðŸ”„ 4ç§’å¸æ°”â†’2ç§’å±æ¯â†’4ç§’å‘¼æ°”çš„ç§‘å­¦å‘¼å¸èŠ‚å¥
          
          ### ðŸš€ å®‰è£…æ–¹æ³•
          1. ä¸‹è½½å¯¹åº”æž¶æž„çš„DMGæ–‡ä»¶
          2. åŒå‡»DMGæ–‡ä»¶æ‰“å¼€
          3. å°†åº”ç”¨æ‹–æ‹½åˆ°Applicationsæ–‡ä»¶å¤¹ï¼ˆDMGä¸­æœ‰Applicationsæ–‡ä»¶å¤¹å¿«æ·æ–¹å¼ï¼‰
          4. ä»Žå¯åŠ¨å°æˆ–Applicationsæ–‡ä»¶å¤¹å¯åŠ¨åº”ç”¨
          
          ### ðŸ’¡ ä½¿ç”¨æŠ€å·§
          - åº”ç”¨ä¼šåœ¨çŠ¶æ€æ æ˜¾ç¤ºï¼Œä¸ä¼šåœ¨Dockä¸­æ˜¾ç¤º
          - å³é”®ç‚¹å‡»çŠ¶æ€æ å›¾æ ‡å¯ä»¥å¼€å§‹/åœæ­¢/é€€å‡º
          - è·ŸéšåŠ¨ç”»èŠ‚å¥è¿›è¡Œå‘¼å¸ç»ƒä¹ 
          
          ---
          
          **æž„å»ºæ—¶é—´ï¼š** ${{ steps.build_time.outputs.BUILD_TIME }}  
          **æž„å»ºç‰ˆæœ¬ï¼š** ${{ github.ref_name }}  
          **æäº¤å“ˆå¸Œï¼š** ${{ github.sha }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  summary:
    needs: [build]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Build Summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Architecture | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|--------------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| x86_64 | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| arm64 | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Artifacts Created" >> $GITHUB_STEP_SUMMARY
        echo "- ${{ env.APP_NAME }}-x86_64.dmg" >> $GITHUB_STEP_SUMMARY
        echo "- ${{ env.APP_NAME }}-arm64.dmg" >> $GITHUB_STEP_SUMMARY 